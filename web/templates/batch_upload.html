{% extends "dashboard_base.html" %}

{% block title %}Batch Upload - Fruit Disease Detection{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto; padding: 40px 20px;">
    <!-- Back Button -->
    <div style="margin-bottom: 30px;">
        <a href="/dashboard" style="display: inline-flex; align-items: center; gap: 8px; background: #667eea; color: white; text-decoration: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 15px; box-shadow: 0 4px 12px rgba(102,126,234,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">
            <span>â†</span> Back to Dashboard
        </a>
    </div>
    
    <!-- Header -->
    <div style="text-align: center; margin-bottom: 50px;">
        <h1 style="font-size: 42px; font-weight: 700; color: #1a1a1a; margin: 0 0 15px 0;">ğŸ“¦ Batch Upload & Processing</h1>
        <p style="font-size: 18px; color: #666; margin: 0;">Analyze multiple fruits and vegetables at once with AI-powered detection</p>
    </div>
    
    <div style="background: white; border-radius: 24px; padding: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 2px solid #f0f0f0;">
        <div style="text-align: center; margin-bottom: 40px;">
            <input type="file" id="batchFiles" multiple accept="image/*" style="display: none;">
            <button onclick="document.getElementById('batchFiles').click()" 
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 20px 50px; border-radius: 16px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 20px rgba(102,126,234,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 28px rgba(102,126,234,0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(102,126,234,0.3)'">
                ğŸ“ Select Multiple Images
            </button>
            <p style="margin-top: 20px; color: #666; font-size: 16px;">Select multiple images to analyze at once â€¢ Supports JPG, PNG formats</p>
        </div>

        <div id="fileList" style="margin: 30px 0; display: none;">
            <div style="background: #f8f9fa; border-radius: 16px; padding: 25px; border: 2px dashed #667eea;">
                <h3 style="margin: 0 0 15px 0; font-size: 20px; color: #1a1a1a;">Selected Files: <span id="fileCount" style="color: #667eea;">0</span></h3>
                <div id="fileNames" style="max-height: 200px; overflow-y: auto; background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;"></div>
                <button id="uploadBtn" onclick="uploadBatch()" 
                        style="background: #10b981; color: white; border: none; padding: 16px 40px; border-radius: 12px; cursor: pointer; font-size: 17px; font-weight: 600; box-shadow: 0 4px 12px rgba(16,185,129,0.3); transition: all 0.3s; width: 100%;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
                    ğŸš€ Analyze All Images
                </button>
            </div>
        </div>

        <div id="progress" style="display: none; margin: 30px 0;">
            <div style="background: #e5e7eb; border-radius: 12px; height: 40px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                <div id="progressBar" style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px;"></div>
            </div>
            <p id="progressText" style="text-align: center; margin-top: 15px; color: #666; font-size: 16px; font-weight: 500;"></p>
        </div>

        <div id="results" style="margin-top: 30px;"></div>
    </div>
</div>

<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>

<script>
const fileInput = document.getElementById('batchFiles');
const fileList = document.getElementById('fileList');
const fileNames = document.getElementById('fileNames');
const fileCount = document.getElementById('fileCount');
const results = document.getElementById('results');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

fileInput.addEventListener('change', function() {
    const files = Array.from(this.files);
    if (files.length > 0) {
        fileList.style.display = 'block';
        fileCount.textContent = files.length;
        fileNames.innerHTML = files.map(f => `<div style="padding: 5px 0;">ğŸ“„ ${f.name}</div>`).join('');
    }
});

async function uploadBatch() {
    const files = fileInput.files;
    if (files.length === 0) return;

    const formData = new FormData();
    for (let file of files) {
        formData.append('files', file);
    }

    document.getElementById('uploadBtn').disabled = true;
    progress.style.display = 'block';
    results.innerHTML = '';

    try {
        const response = await fetch('/batch_predict', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        
        if (data.success) {
            displayResults(data.results);
            generateReport(data.results);
        } else {
            results.innerHTML = `<div style="color: red; text-align: center;">âŒ Error: ${data.error}</div>`;
        }
    } catch (error) {
        results.innerHTML = `<div style="color: red; text-align: center;">âŒ Error: ${error.message}</div>`;
    }

    document.getElementById('uploadBtn').disabled = false;
    progress.style.display = 'none';
}

function displayResults(data) {
    const healthy = data.filter(r => r.is_healthy).length;
    const diseased = data.length - healthy;

    results.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: 0 10px 30px rgba(102,126,234,0.3);">
            <h2 style="color: white; margin: 0 0 30px 0; font-size: 28px; font-weight: 700;">ğŸ“Š Analysis Summary</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                <div style="background: rgba(255,255,255,0.95); padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; font-weight: 800; color: #667eea; margin-bottom: 8px;">${data.length}</div>
                    <div style="color: #666; font-size: 16px; font-weight: 600;">Total Images</div>
                </div>
                <div style="background: rgba(255,255,255,0.95); padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; font-weight: 800; color: #10b981; margin-bottom: 8px;">${healthy}</div>
                    <div style="color: #666; font-size: 16px; font-weight: 600;">Healthy</div>
                </div>
                <div style="background: rgba(255,255,255,0.95); padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; font-weight: 800; color: #ef4444; margin-bottom: 8px;">${diseased}</div>
                    <div style="color: #666; font-size: 16px; font-weight: 600;">Diseased</div>
                </div>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap; justify-content: center;">
                <button onclick="downloadReport()" style="background: white; color: #667eea; border: none; padding: 14px 35px; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                    ğŸ“¥ Download Report (CSV)
                </button>
                <a href="/dashboard" style="display: inline-flex; align-items: center; gap: 8px; background: white; color: #667eea; text-decoration: none; padding: 14px 35px; border-radius: 12px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                    ğŸ  Back to Dashboard
                </a>
            </div>
        </div>

        <h2 style="font-size: 28px; font-weight: 700; color: #1a1a1a; margin: 0 0 25px 0;">ğŸ” Detailed Results</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px;">
            ${data.map(r => `
                <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.08); transition: all 0.3s; border: 2px solid ${r.is_healthy ? '#10b981' : '#ef4444'};" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.08)'">
                    <img src="${r.image_url}" style="width: 100%; height: 220px; object-fit: cover;">
                    <div style="padding: 20px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: #1a1a1a;">${r.fruit}</h3>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="background: ${r.is_healthy ? '#10b981' : '#ef4444'}; color: white; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                ${r.condition}
                            </span>
                            <span style="color: #666; font-size: 15px; font-weight: 600;">${r.confidence}</span>
                        </div>
                        <div style="font-size: 13px; color: #999; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;">ğŸ“„ ${r.filename}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

let reportData = [];
function generateReport(data) {
    reportData = data;
}

function downloadReport() {
    const csv = [
        ['Filename', 'Fruit', 'Condition', 'Confidence', 'Status'],
        ...reportData.map(r => [
            r.filename,
            r.fruit,
            r.condition,
            r.confidence,
            r.is_healthy ? 'Healthy' : 'Diseased'
        ])
    ].map(row => row.join(',')).join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `batch_analysis_${Date.now()}.csv`;
    a.click();
}

// Mobile Navigation Toggle
document.addEventListener('DOMContentLoaded', function() {
    const mobileToggle = document.getElementById('mobileNavToggle');
    const heroMenu = document.getElementById('heroMenu');
    const mobileOverlay = document.getElementById('mobileOverlay');
    
    if (mobileToggle && heroMenu) {
        mobileToggle.addEventListener('click', function() {
            heroMenu.classList.toggle('open');
            if (mobileOverlay) mobileOverlay.classList.toggle('active');
            mobileToggle.textContent = heroMenu.classList.contains('open') ? 'âœ•' : 'â˜°';
        });
        
        // Close menu when overlay is clicked
        if (mobileOverlay) {
            mobileOverlay.addEventListener('click', function() {
                heroMenu.classList.remove('open');
                mobileOverlay.classList.remove('active');
                mobileToggle.textContent = 'â˜°';
            });
        }
        
        // Close menu when window is resized to desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                heroMenu.classList.remove('open');
                if (mobileOverlay) mobileOverlay.classList.remove('active');
                mobileToggle.textContent = 'â˜°';
            }
        });
    }
});
</script>

<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>

{% endblock %}
